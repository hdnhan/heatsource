-- FreeFem++ v  3.610001 (date jeu. 12 juil. 2018 15:05:23)
 Load: lg_fem lg_mesh lg_mesh3 eigenvalue
    1 : load "ff-IpOpt"(load: loadLibary C:\Program Files (x86)\FreeFem++\\.\ff-IpOpt = 0)
    2 : load "medit"(load: loadLibary C:\Program Files (x86)\FreeFem++\\.\medit = 0)
    3 :
    4 : real T = 1;
    5 : int nn = 50;
    6 : int Nx = nn, Ny = nn;
    7 : int[int] labs = [1, 2, 0, 4];
    8 : mesh Th = square(Nx, Ny, [x, T * y], label = labs);
    9 : fespace Vh(Th, P1);
   10 :
   11 : Vh ue = sin(pi * x) * sin(pi * y);
   12 : Vh uN = pi * cos(pi * x) * sin(pi * y);
   13 : Vh u0 = ue(x, 0);
   14 : Vh a = 1;
   15 : Vh q = x * y + 1;
   16 : Vh fe = (1 + y^0) * (x * (x <= 0.5) + (1 - x) * (x > 0.5));
   17 : Vh g = pi * sin(pi * x) * cos(pi * y) + a * pi^2 * sin(pi * x) * sin(pi * y) - fe * q;
   18 : real gamma = 1e-6;
   19 :
   20 :
   21 : Vh u, f = 0;
   22 :
   23 : // State equation:
   24 : func real[int] StateProblem(real[int] & f){
   25 :     Vh u, v, ff; ff[] = f;
   26 :     Vh rsh = ff * q + g;
   27 :
   28 :     solve SpaceTime(u, v, solver = sparsesolver) =
   29 :           int2d(Th)(dy(u)  * v + a * dx(u)  * dx(v))
   30 :         + int2d(Th)(dy(u0) * v + a * dx(u0) * dx(v))
   31 :         - int1d(Th, 2) (uN * v) + int1d(Th, 4) (uN * v)
   32 :         - int2d(Th)(rsh * v)
   33 :         + on(1, u = 0);
   34 :
   35 :     u = u + u0;
   36 :     return u[];
   37 : }
   38 :
   39 :
   40 : func real[int] flip(real[int] u){
   41 :     Vh uu;
   42 :     for (int i =0; i <= Ny/2; i++){
   43 :         for (int j=0; j <= Nx; j++){
   44 :             uu[][i * (Nx + 1) + j] = u[(Ny - i) * (Nx + 1) + j];
   45 :             uu[][(Ny - i) * (Nx + 1) + j] = u[i * (Nx + 1) + j];
   46 :         }
   47 :     }
   48 :     return uu[];
   49 : }
   50 :
   51 :
   52 : // Adjoint equation
   53 : func real[int] AdjointProblem(real[int] & u){
   54 :     Vh p, v, uu; uu[] = u;
   55 :     Vh temp = uu - ue;
   56 :     Vh rsh =  flip(temp[]);
   57 :     Vh pN = 0;
   58 :
   59 :     solve SpaceTime(p, v, solver = sparsesolver) =
   60 :           int2d(Th)(dy(p) * v + a(x, T-y) * dx(p) * dx(v))
   61 :         - int1d(Th, 2, 4)(pN * v)
   62 :         - int2d(Th)(rsh * v) + on(1, p = 0);
   63 :
   64 :     return flip(p[]);
   65 : }
   66 :
   67 :
   68 : // Tikhonov functional
   69 : func real J(real[int] & f) {
   70 :     Vh ff; ff[] = f;
   71 :     u[] = StateProblem(f);
   72 :     return 0.5 * int2d(Th)((u - ue)^2) + 0.5 * gamma * int2d(Th)(ff^2);
   73 : }
   74 :
   75 :
   76 : // Gradient of Tikhonov funtional
   77 : func real[int] GradJ(real[int] & f) {
   78 :     Vh ff; ff[] = f;
   79 :     Vh p; p[] = AdjointProblem(StateProblem(f));
   80 :     Vh res = p * q + gamma * ff;
   81 :     return res[];
   82 : }
   83 :
   84 : //Vh f = 0;
   85 : //IPOPT(J, GradJ, f[], tol = 1e-4);
   86 : //NLCG(GradJ, f[], nbiter=10, eps = 1e-3);
   87 : LinearCG(GradJ, f[], eps = 1e-6);
   88 :
   89 : //savemesh(Th, "IP1.mesh");
   90 : //savesol("IP1.sol", Th, f);
   91 : //savemesh(Th, "IPe.mesh");
   92 : //savesol("IPe.sol", Th, fe);
   93 :
   94 : //Vh u; u[] = StateProblem(f[]);
   95 :
   96 : plot(ue, wait = 1, dim=3d);
   97 : plot(u, wait = 1, dim=3d);
   98 : plot(u, ue, wait = 1, dim=3d);
   99 :
  100 : plot(fe, wait = 1, dim=3d);
  101 : plot(f, wait = 1, dim=3d);
  102 : plot(f, fe, wait = 1, dim=3d);
  103 : cout << "Error: " << sqrt(int2d(Th)((fe - f)^2)) << endl;
  104 :  sizestack + 1024 =10440  ( 9416 )
 
  -- Square mesh : nb vertices  =2601 ,  nb triangles = 5000 ,  nb boundary edges 200
  -- Solve :
          min -0.640547  max 0.724712
  -- Solve :
          min -0.292457  max 1.26332e-034
  -- Solve :
          min -0.352703  max 0.879297
  -- Solve :
          min -0.129347  max 6.82552e-035
  -- Solve :
          min -0.107692  max 1.01396
  -- Solve :
          min -0.00833267  max 0.00581966
  -- Solve :
          min -0.062062  max 0.979292
  -- Solve :
          min -0.00644031  max 1.00037e-035
  -- Solve :
          min -0.0164406  max 0.997277
  -- Solve :
          min -6.53501e-036  max 0.0108335
  -- Solve :
          min -0.0357552  max 0.987203
  -- Solve :
          min -0.000734664  max 0.0014798
  -- Solve :
          min -0.0287287  max 0.995619
  -- Solve :
          min -0.00244566  max 0.00146206
  -- Solve :
          min -0.0365815  max 0.987853
  -- Solve :
          min -0.00394917  max 3.95974e-036
  -- Solve :
          min -0.0319841  max 0.990841
  -- Solve :
          min -0.000701169  max 0.00076917
  -- Solve :
          min -0.0232124  max 0.984572
  -- Solve :
          min -0.00469271  max 0.000470187
  -- Solve :
          min -0.0474788  max 0.989915
  -- Solve :
          min -0.00587755  max 0.0129341
  -- Solve :
          min -0.0070051  max 0.988439
  -- Solve :
          min -0.00186606  max 0.0035551
  -- Solve :
          min -0.00562095  max 0.988496
  -- Solve :
          min -0.00169632  max 0.00326309
  -- Solve :
          min -0.00452227  max 0.989833
  -- Solve :
          min -0.00153265  max 0.00383983
  -- Solve :
          min -0.00246112  max 0.992296
  -- Solve :
          min -0.00110366  max 0.00476264
  -- Solve :
          min -0.000875875  max 0.995774
  -- Solve :
          min -0.000228876  max 0.0062849
  -- Solve :
          min -0.00403462  max 1.0013
  -- Solve :
          min -9.75695e-036  max 0.00915676
  -- Solve :
          min -0.0095477  max 1.0052
  -- Solve :
          min -1.8219e-035  max 0.0103299
  -- Solve :
          min -0.0145447  max 1.00712
  -- Solve :
          min -2.35776e-035  max 0.0104738
  -- Solve :
          min -0.0187342  max 1.00809
  -- Solve :
          min -0.000317412  max 0.0101919
  -- Solve :
          min -0.022299  max 1.00851
  -- Solve :
          min -0.00113711  max 0.00968729
  -- Solve :
          min -0.0252941  max 1.00854
  -- Solve :
          min -0.00186469  max 0.00905373
  -- Solve :
          min -0.0277724  max 1.00831
  -- Solve :
          min -0.00249694  max 0.00836265
  -- Solve :
          min -0.0298133  max 1.00791
  -- Solve :
          min -0.00304558  max 0.00766252
  -- Solve :
          min -0.031504  max 1.00742
  -- Solve :
          min -0.00355384  max 0.00697923
  -- Solve :
          min -0.0329253  max 1.00689
  -- Solve :
          min -0.00399724  max 0.00632175
  -- Solve :
          min -0.0341458  max 1.00632
  -- Solve :
          min -0.00439061  max 0.00568804
  -- Solve :
          min -0.0352217  max 1.00573
  -- Solve :
          min -0.00474761  max 0.00506925
  -- Solve :
          min -0.0361984  max 1.00511
  -- Solve :
          min -0.00508028  max 0.00445238
  -- Solve :
          min -0.037112  max 1.00446
  -- Solve :
          min -0.0054053  max 0.00382175
  -- Solve :
          min -0.0379908  max 1.00374
  -- Solve :
          min -0.00574844  max 0.00330964
  -- Solve :
          min -0.0388556  max 1.00295
  -- Solve :
          min -0.00609484  max 0.00319301
  -- Solve :
          min -0.0397203  max 1.00206
  -- Solve :
          min -0.0064503  max 0.00305481
  -- Solve :
          min -0.0405913  max 1.00105
  -- Solve :
          min -0.00681835  max 0.0028894
  -- Solve :
          min -0.0414665  max 0.999884
  -- Solve :
          min -0.00722446  max 0.00270704
  -- Solve :
          min -0.0423345  max 0.998545
  -- Solve :
          min -0.00766059  max 0.0025049
  -- Solve :
          min -0.0431737  max 0.997013
  -- Solve :
          min -0.00811575  max 0.00225472
  -- Solve :
          min -0.0439522  max 0.995275
  -- Solve :
          min -0.00861618  max 0.00194923
  -- Solve :
          min -0.0446291  max 0.993331
  -- Solve :
          min -0.00915867  max 0.0015826
  -- Solve :
          min -0.0451577  max 0.991194
  -- Solve :
          min -0.00975633  max 0.00115152
  -- Solve :
          min -0.0454898  max 0.988893
  -- Solve :
          min -0.0104493  max 0.000656184
  -- Solve :
          min -0.0460069  max 0.986475
  -- Solve :
          min -0.0112728  max 0.000100868
  -- Solve :
          min -0.0476537  max 0.984584
  -- Solve :
          min -0.0124959  max 9.61273e-005
  -- Solve :
          min -0.0491139  max 0.984016
  -- Solve :
          min -0.0140375  max 0.000109581
  -- Solve :
          min -0.0503436  max 0.983898
  -- Solve :
          min -0.0156563  max 0.000136255
  -- Solve :
          min -0.0513126  max 0.984088
  -- Solve :
          min -0.0171495  max 0.000184688
  -- Solve :
          min -0.0520059  max 0.984461
  -- Solve :
          min -0.0184883  max 0.000254059
  -- Solve :
          min -0.0524227  max 0.985003
  -- Solve :
          min -0.0196539  max 0.000333108
  -- Solve :
          min -0.0525741  max 0.985695
  -- Solve :
          min -0.0206366  max 0.000419899
  -- Solve :
          min -0.0524802  max 0.986514
  -- Solve :
          min -0.0214343  max 0.00051246
  -- Solve :
          min -0.0521668  max 0.987438
  -- Solve :
          min -0.0220526  max 0.000608909
CG:49  ro = 0.0136893 ||g||^2 = 0.558393 0
  -- Solve :
          min -0.051663  max 0.988443
  -- Solve :
          min -0.0225026  max 0.000707539
  -- Solve :
          min -0.0512256  max 0.989507
  -- Solve :
          min -0.0227984  max 0.000820171
  -- Solve :
          min -0.0538239  max 0.990611
  -- Solve :
          min -0.0229562  max 0.000999123
  -- Solve :
          min -0.0562839  max 0.991737
  -- Solve :
          min -0.0229926  max 0.00117659
  -- Solve :
          min -0.0584454  max 0.992873
  -- Solve :
          min -0.022924  max 0.001351
  -- Solve :
          min -0.0603304  max 0.994005
  -- Solve :
          min -0.0227659  max 0.00152115
  -- Solve :
          min -0.062121  max 0.995126
  -- Solve :
          min -0.0225326  max 0.00168617
  -- Solve :
          min -0.0636802  max 0.996227
  -- Solve :
          min -0.0222368  max 0.00184546
  -- Solve :
          min -0.0650238  max 0.997304
  -- Solve :
          min -0.02189  max 0.00199866
  -- Solve :
          min -0.0661738  max 0.998352
  -- Solve :
          min -0.0215021  max 0.00243877
  -- Solve :
          min -0.0671511  max 0.99937
  -- Solve :
          min -0.0210815  max 0.00297777
  -- Solve :
          min -0.0679749  max 1.00035
  -- Solve :
          min -0.0206355  max 0.00349692
  -- Solve :
          min -0.0686625  max 1.00131
  -- Solve :
          min -0.0201702  max 0.00399614
  -- Solve :
          min -0.0692297  max 1.00223
  -- Solve :
          min -0.0196907  max 0.00447571
  -- Solve :
          min -0.069723  max 1.00311
  -- Solve :
          min -0.019201  max 0.0049361
  -- Solve :
          min -0.0701639  max 1.00397
  -- Solve :
          min -0.0187046  max 0.00537799
  -- Solve :
          min -0.0705184  max 1.00479
  -- Solve :
          min -0.018204  max 0.0058022
  -- Solve :
          min -0.0707965  max 1.00559
  -- Solve :
          min -0.0177014  max 0.00620984
  -- Solve :
          min -0.0710071  max 1.00636
  -- Solve :
          min -0.0171984  max 0.00662089
  -- Solve :
          min -0.0711575  max 1.0071
  -- Solve :
          min -0.016696  max 0.00703032
  -- Solve :
          min -0.0712545  max 1.00782
  -- Solve :
          min -0.0161951  max 0.00742505
  -- Solve :
          min -0.0713038  max 1.00852
  -- Solve :
          min -0.0156961  max 0.00780615
  -- Solve :
          min -0.0713102  max 1.00919
  -- Solve :
          min -0.0151993  max 0.00817469
  -- Solve :
          min -0.071278  max 1.00985
  -- Solve :
          min -0.0147045  max 0.00853172
  -- Solve :
          min -0.0712106  max 1.01049
  -- Solve :
          min -0.0142116  max 0.00887829
  -- Solve :
          min -0.0711111  max 1.01112
  -- Solve :
          min -0.0137201  max 0.00921539
  -- Solve :
          min -0.0709817  max 1.01173
  -- Solve :
          min -0.0132296  max 0.00954401
  -- Solve :
          min -0.0708246  max 1.01234
  -- Solve :
          min -0.0127394  max 0.00986511
  -- Solve :
          min -0.0706413  max 1.01293
  -- Solve :
          min -0.0122487  max 0.0101796
  -- Solve :
          min -0.0704329  max 1.01351
  -- Solve :
          min -0.0117568  max 0.0104884
  -- Solve :
          min -0.0702002  max 1.01409
  -- Solve :
          min -0.0112626  max 0.0107923
  -- Solve :
          min -0.0699438  max 1.01467
  -- Solve :
          min -0.0107653  max 0.0110922
  -- Solve :
          min -0.0696638  max 1.01524
  -- Solve :
          min -0.0102637  max 0.011389
  -- Solve :
          min -0.0693603  max 1.01581
  -- Solve :
          min -0.00975688  max 0.0116833
  -- Solve :
          min -0.0690329  max 1.01638
  -- Solve :
          min -0.00964166  max 0.0119759
  -- Solve :
          min -0.0686811  max 1.01695
  -- Solve :
          min -0.00959218  max 0.0122674
  -- Solve :
          min -0.0683041  max 1.01752
  -- Solve :
          min -0.00953855  max 0.0125586
  -- Solve :
          min -0.0679011  max 1.0181
  -- Solve :
          min -0.0094806  max 0.0128754
  -- Solve :
          min -0.0674708  max 1.01868
  -- Solve :
          min -0.00941812  max 0.0131949
  -- Solve :
          min -0.0670306  max 1.01927
  -- Solve :
          min -0.00935086  max 0.0135163
  -- Solve :
          min -0.0665833  max 1.01987
  -- Solve :
          min -0.00927857  max 0.0138403
  -- Solve :
          min -0.066105  max 1.02048
  -- Solve :
          min -0.00920094  max 0.0141675
  -- Solve :
          min -0.0655939  max 1.0211
  -- Solve :
          min -0.00911765  max 0.0144983
  -- Solve :
          min -0.0650482  max 1.02173
  -- Solve :
          min -0.00902833  max 0.0148334
  -- Solve :
          min -0.0644657  max 1.02238
  -- Solve :
          min -0.00893261  max 0.0151732
  -- Solve :
          min -0.0638443  max 1.02303
  -- Solve :
          min -0.00883006  max 0.0155181
  -- Solve :
          min -0.0631817  max 1.02371
  -- Solve :
          min -0.00872026  max 0.0158685
  -- Solve :
          min -0.0624754  max 1.0244
  -- Solve :
          min -0.00860273  max 0.016225
  -- Solve :
          min -0.0617228  max 1.02511
  -- Solve :
          min -0.008477  max 0.0165878
  -- Solve :
          min -0.0609211  max 1.02584
  -- Solve :
          min -0.00834254  max 0.0169571
CG:99  ro = 0.00373813 ||g||^2 = 0.326102 0
  -- Solve :
          min -0.0600677  max 1.02659
  -- Solve :
          min -0.00819883  max 0.0173331
CG does'nt converge: 100 ||g||^2 = 0.351409 reps2= 1.65587e-010
Warning: May be a bug in your script,
 a part of the plot is wrong t (mesh or FE function, curve)  => skip the item  1 in plot command
 Error plot item empty 0
Warning: May be a bug in your script,
 a part of the plot is wrong t (mesh or FE function, curve)  => skip the item  1 in plot command
 Error plot item empty 0
 Error plot item empty 0
 Error plot item empty 0
Error: 0.293179
times: compile 0.292s, execution 17.221s,  mpirank:0
 ######## We forget of deleting   6982 Nb pointer,   0Bytes  ,  mpirank 0, memory leak =0
 CodeAlloc : nb ptr  3460,  size :411800 mpirank: 0
Ok: Normal End
 try getConsole D:\Study\HUST\FEM\heatsource\FreeFem++\HeatSource1D_Q.edp
